/**
 * 根据传入 demo 生成小程序预览项目对应页面
 */
const fse = require('fs-extra');
const path = require('path');
const { platformMap } = require('miniapp-builder-shared');
const hbs = require('handlebars');

const jsHbsTemplatePath = path.join(__dirname, '../../template/runtimeMiniappPage.hbs');
const hbsTemplateContent = fse.readFileSync(jsHbsTemplatePath, 'utf-8');

module.exports = function (outputPath, name, target) {
  const tmplDir = path.resolve(__dirname, `../../template/miniapp/${target}/pages/Demo/`);
  const files = [
    'index.json',
    // eg: index.wxcss
    `index${platformMap[target].extension.css}`,
    // eg: idnex.wxml
    `index${platformMap[target].extension.xml}`,
  ];

  // copy acss, json, axml files
  try {
    files.forEach((filename) => {
      fse.copySync(path.resolve(tmplDir, filename), path.resolve(outputPath, filename));
    });
  } catch (e) {
    console.log(e);
  }

  // generate pages/{demo}/index.js
  const compileContent = hbs.compile(hbsTemplateContent);
  const jsTemplateContent = compileContent({
    pageName: name,
  });

  fse.writeFileSync(path.resolve(outputPath, 'index.js'), jsTemplateContent);
};
