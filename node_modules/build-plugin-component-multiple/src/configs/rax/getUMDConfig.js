const camelcase = require('camelcase');
const getDistConfig = require('./getDistConfig');

module.exports = (context, options) => {
  const config = getDistConfig(context, options);
  const {
    library,
    // library target
    libraryTarget = 'umd',
    // library export, default is undefined
    libraryExport,
    filename = 'index.umd.js',
  } = options;
  const { pkg } = context;
  const pkgName = camelcase(pkg.name || '', { pascalCase: true });

  config.output.library(library || pkgName).libraryTarget(libraryTarget);
  config.externals([
    function (ctx, request, callback) {
      if (request.indexOf('@weex-module') !== -1) {
        return callback(null, `commonjs ${request}`);
      }
      // Built-in modules in QuickApp
      if (request.indexOf('@system') !== -1) {
        return callback(null, `commonjs ${request}`);
      }

      if (request === 'rax') {
        return callback(null, 'var window.Rax');
      }

      callback();
    },
  ]);

  if (libraryExport) {
    config.output.libraryExport(libraryExport);
  }

  config.output.filename(filename);

  return config;
};
